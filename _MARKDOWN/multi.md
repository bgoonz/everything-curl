<a href="../../index.html" class="link-a079aa82--primary-53a25e66--logoLink-10d08504"></a>

<img src="https://gblobscdn.gitbook.com/orgs%2F-LxuH0qSm4xO9nWfEBlB%2Favatar.png?alt=media" class="image-67b14f24--avatar-1c1d03ec" />

<span class="text-4505230f--UIH400-4e41e82a--textContentFamily-49a318e1--spaceNameText-677c2969">Everything curl</span>

<a href="../../index.html" class="link-a079aa82--primary-53a25e66--logoLink-10d08504"></a>

<img src="https://gblobscdn.gitbook.com/orgs%2F-LxuH0qSm4xO9nWfEBlB%2Favatar.png?alt=media" class="image-67b14f24--avatar-1c1d03ec" />

<span class="text-4505230f--UIH400-4e41e82a--textContentFamily-49a318e1--spaceNameText-677c2969">Everything curl</span>

<a href="../../index.html" class="navButton-94f2579c--navButtonClickable-161b88ca"><span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">Introduction</span></a>

<a href="../../how-to-read.html" class="navButton-94f2579c--navButtonClickable-161b88ca"><span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">How to read this book</span></a>

<span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">The cURL project</span>

<span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">Get curl</span>

<span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">Open Source</span>

<span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">The source code</span>

<span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">Network and protocols</span>

<span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">Command line basics</span>

<span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">Using curl</span>

<span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">How to HTTP with curl</span>

<span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">libcurl basics</span>

<a href="../easyhandle.html" class="navButton-94f2579c--pageItemWithChildrenNested-2c5d8183--navButtonClickable-161b88ca"><span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">Easy handle</span></a>

<span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">Drive transfers</span>

<a href="easy.html" class="navButton-94f2579c--pageItemWithChildrenNested-2c5d8183--navButtonClickable-161b88ca"><span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">Drive with easy</span></a>

<a href="multi.html" class="navButton-94f2579c--pageItemWithChildrenNested-2c5d8183--navButtonClickable-161b88ca--navButtonOpened-6a88552e"><span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">Drive with multi</span></a>

<a href="multi-socket.html" class="navButton-94f2579c--pageItemWithChildrenNested-2c5d8183--navButtonClickable-161b88ca"><span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">Drive with multi_socket</span></a>

<a href="../connectionreuse.html" class="navButton-94f2579c--pageItemWithChildrenNested-2c5d8183--navButtonClickable-161b88ca"><span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">Connection reuse</span></a>

<span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">Callbacks</span>

<a href="../cleanup.html" class="navButton-94f2579c--pageItemWithChildrenNested-2c5d8183--navButtonClickable-161b88ca"><span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">Cleanup</span></a>

<a href="../names.html" class="navButton-94f2579c--pageItemWithChildrenNested-2c5d8183--navButtonClickable-161b88ca"><span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">Name resolving</span></a>

<a href="../proxies.html" class="navButton-94f2579c--pageItemWithChildrenNested-2c5d8183--navButtonClickable-161b88ca"><span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">Proxies</span></a>

<a href="../getinfo.html" class="navButton-94f2579c--pageItemWithChildrenNested-2c5d8183--navButtonClickable-161b88ca"><span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">Post transfer info</span></a>

<a href="../sharing.html" class="navButton-94f2579c--pageItemWithChildrenNested-2c5d8183--navButtonClickable-161b88ca"><span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">Share data between handles</span></a>

<a href="../url.html" class="navButton-94f2579c--pageItemWithChildrenNested-2c5d8183--navButtonClickable-161b88ca"><span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">URL API</span></a>

<a href="../api.html" class="navButton-94f2579c--pageItemWithChildrenNested-2c5d8183--navButtonClickable-161b88ca"><span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">API compatibility</span></a>

<a href="../libcurl.html" class="navButton-94f2579c--pageItemWithChildrenNested-2c5d8183--navButtonClickable-161b88ca"><span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">--libcurl</span></a>

<a href="../headers.html" class="navButton-94f2579c--pageItemWithChildrenNested-2c5d8183--navButtonClickable-161b88ca"><span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">Header files</span></a>

<a href="../globalinit.html" class="navButton-94f2579c--pageItemWithChildrenNested-2c5d8183--navButtonClickable-161b88ca"><span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">Global initialization</span></a>

<a href="../threading.html" class="navButton-94f2579c--pageItemWithChildrenNested-2c5d8183--navButtonClickable-161b88ca"><span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">multi-threading</span></a>

<span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">curl easy options</span>

<a href="../curlcode.html" class="navButton-94f2579c--pageItemWithChildrenNested-2c5d8183--navButtonClickable-161b88ca"><span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">CURLcode return codes</span></a>

<a href="../verbose.html" class="navButton-94f2579c--pageItemWithChildrenNested-2c5d8183--navButtonClickable-161b88ca"><span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">Verbose operations</span></a>

<span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">libcurl examples</span>

<a href="../cplusplus.html" class="navButton-94f2579c--pageItemWithChildrenNested-2c5d8183--navButtonClickable-161b88ca"><span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">for C++ programmers</span></a>

<span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">HTTP with libcurl</span>

<a href="../../bindings.html" class="navButton-94f2579c--navButtonClickable-161b88ca"><span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">Bindings</span></a>

<a href="../../internals.html" class="navButton-94f2579c--navButtonClickable-161b88ca"><span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f">libcurl internals</span></a>

<a href="../../bookindex.html" class="navButton-94f2579c--navButtonClickable-161b88ca"><span class="text-4505230f--UIH300-2063425d--textContentFamily-49a318e1--navButtonLabel-14a4968f"></span></a>

<a href="https://www.gitbook.com/?utm_source=content&amp;utm_medium=trademark&amp;utm_campaign=curl-1" class="reset-3c756112--trademark-a8da4b94"></a>

<span class="text-4505230f--TextH200-a3425406--textUIFamily-5ebd8e40"></span>

# <span class="text-4505230f--DisplayH900-bfb998fa--textContentFamily-49a318e1">Drive with multi</span>

<span class="text-4505230f--UIH300-2063425d--textUIFamily-5ebd8e40--text-8ee2c8b2"></span>

<span class="text-4505230f--TextH400-3033861f--textContentFamily-49a318e1"><span data-key="c12bff999e0c41a89baf035856f7322a"><span data-offset-key="c12bff999e0c41a89baf035856f7322a:0">The name 'multi' is for multiple, as in multiple parallel transfers, all done in the same single thread. The multi API is non-blocking so it can also make sense to use it for single transfers.</span></span></span>

<span class="text-4505230f--TextH400-3033861f--textContentFamily-49a318e1"><span data-key="f56ef0f098d74ec089ee05076b0dc116"><span data-offset-key="f56ef0f098d74ec089ee05076b0dc116:0">The transfer is still set in an "easy" </span><span data-offset-key="f56ef0f098d74ec089ee05076b0dc116:1">`CURL *`</span><span data-offset-key="f56ef0f098d74ec089ee05076b0dc116:2"> handle as described </span></span><a href="../easyhandle.html" class="link-a079aa82--primary-53a25e66--link-faf6c434"><span data-key="cd1907fd408644628f8d902326a3f47a"><span data-offset-key="cd1907fd408644628f8d902326a3f47a:0">above</span></span></a><span data-key="a7c9bd8e544745d49b58d2d24d895e58"><span data-offset-key="a7c9bd8e544745d49b58d2d24d895e58:0">, but with the multi interface you also need a multi </span><span data-offset-key="a7c9bd8e544745d49b58d2d24d895e58:1">`CURLM *`</span><span data-offset-key="a7c9bd8e544745d49b58d2d24d895e58:2"> handle created and use that to drive all the individual transfers. The multi handle can "hold" one or many easy handles:</span></span></span>

    CURLM *multi_handle = curl_multi_init();

<span class="text-4505230f--TextH400-3033861f--textContentFamily-49a318e1"><span data-key="3ef9864abb164b2fba23c3a9c243d7fe"><span data-offset-key="3ef9864abb164b2fba23c3a9c243d7fe:0">A multi handle can also get certain options set, which you do with </span><span data-offset-key="3ef9864abb164b2fba23c3a9c243d7fe:1">`curl_multi_setopt()`</span><span data-offset-key="3ef9864abb164b2fba23c3a9c243d7fe:2">, but in the simplest case you might not have anything to set there.</span></span></span>

<span class="text-4505230f--TextH400-3033861f--textContentFamily-49a318e1"><span data-key="ac7ba4d3dee248469fb0d22fd20378ea"><span data-offset-key="ac7ba4d3dee248469fb0d22fd20378ea:0">To drive a multi interface transfer, you first need to add all the individual easy handles that should be transferred to the multi handle. You can add them to the multi handle at any point and you can remove them again whenever you like. Removing an easy handle from a multi handle will, of course, remove the association and that particular transfer would stop immediately.</span></span></span>

<span class="text-4505230f--TextH400-3033861f--textContentFamily-49a318e1"><span data-key="bbf625c4d4b348a2afb7141b0445e417"><span data-offset-key="bbf625c4d4b348a2afb7141b0445e417:0">Adding an easy handle to the multi handle is easy:</span></span></span>

    curl_multi_add_handle( multi_handle, easy_handle );

<span class="text-4505230f--TextH400-3033861f--textContentFamily-49a318e1"><span data-key="56ac77b7635048d69777c915b71a7e90"><span data-offset-key="56ac77b7635048d69777c915b71a7e90:0">Removing one is just as easily done:</span></span></span>

    curl_multi_remove_handle( multi_handle, easy_handle );

<span class="text-4505230f--TextH400-3033861f--textContentFamily-49a318e1"><span data-key="3e6750580f5d4a62b97b82b585f9b030"><span data-offset-key="3e6750580f5d4a62b97b82b585f9b030:0">Having added the easy handles representing the transfers you want to perform, you write the transfer loop. With the multi interface, you do the looping so you can ask libcurl for a set of file descriptors and a timeout value and do the </span><span data-offset-key="3e6750580f5d4a62b97b82b585f9b030:1">`select()`</span><span data-offset-key="3e6750580f5d4a62b97b82b585f9b030:2"> call yourself, or you can use the slightly simplified version which does that for us, with </span><span data-offset-key="3e6750580f5d4a62b97b82b585f9b030:3">`curl_multi_wait`</span><span data-offset-key="3e6750580f5d4a62b97b82b585f9b030:4">. The simplest loop could look like this: (</span><span data-offset-key="3e6750580f5d4a62b97b82b585f9b030:5">_note that a real application would check return codes_</span><span data-offset-key="3e6750580f5d4a62b97b82b585f9b030:6">)</span></span></span>

    int transfers_running;do {   curl_multi_wait ( multi_handle, NULL, 0, 1000, NULL);   curl_multi_perform ( multi_handle, &transfers_running );} while (transfers_running);

<span class="text-4505230f--TextH400-3033861f--textContentFamily-49a318e1"><span data-key="586ab0e934924715aecafc3f5e18b902"><span data-offset-key="586ab0e934924715aecafc3f5e18b902:0">The fourth argument to </span><span data-offset-key="586ab0e934924715aecafc3f5e18b902:1">`curl_multi_wait`</span><span data-offset-key="586ab0e934924715aecafc3f5e18b902:2">, set to 1000 in the example above, is a timeout in milliseconds. It is the longest time the function will wait for any activity before it returns anyway. You do not want to lock up for too long before calling </span><span data-offset-key="586ab0e934924715aecafc3f5e18b902:3">`curl_multi_perform`</span><span data-offset-key="586ab0e934924715aecafc3f5e18b902:4"> again as there are timeouts, progress callbacks and more that may lose precision if you do so.</span></span></span>

<span class="text-4505230f--TextH400-3033861f--textContentFamily-49a318e1"><span data-key="aef6eee4112c4043a8277369db50694a"><span data-offset-key="aef6eee4112c4043a8277369db50694a:0">To instead do select() on our own, we extract the file descriptors and timeout value from libcurl like this (</span><span data-offset-key="aef6eee4112c4043a8277369db50694a:1">_note that a real application would check return codes_</span><span data-offset-key="aef6eee4112c4043a8277369db50694a:2">):</span></span></span>

    int transfers_running;do {  fd_set fdread;  fd_set fdwrite;  fd_set fdexcep;  int maxfd = -1;  long timeout;​  /* extract timeout value */  curl_multi_timeout(multi_handle, &timeout);  if (timeout < 0)    timeout = 1000;​  /* convert to struct usable by select */  timeout.tv_sec = timeout / 1000;  timeout.tv_usec = (timeout % 1000) * 1000;​  FD_ZERO(&fdread);  FD_ZERO(&fdwrite);  FD_ZERO(&fdexcep);​  /* get file descriptors from the transfers */  mc = curl_multi_fdset(multi_handle, &fdread, &fdwrite, &fdexcep, &maxfd);​  if (maxfd == -1) {    SHORT_SLEEP;  }  else   select(maxfd+1, &fdread, &fdwrite, &fdexcep, &timeout);​  /* timeout or readable/writable sockets */  curl_multi_perform(multi_handle, &transfers_running);} while ( transfers_running );

<span class="text-4505230f--TextH400-3033861f--textContentFamily-49a318e1"><span data-key="431c552f03334390ac1142562ffe0b00"><span data-offset-key="431c552f03334390ac1142562ffe0b00:0">Both these loops let you use one or more file descriptors of your own on which to wait, like if you read from your own sockets or a pipe or similar.</span></span></span>

<span class="text-4505230f--TextH400-3033861f--textContentFamily-49a318e1"><span data-key="5964203ca95d4917a4293e08f40f6426"><span data-offset-key="5964203ca95d4917a4293e08f40f6426:0">And again, you can add and remove easy handles to the multi handle at any point during the looping. Removing a handle mid-transfer will, of course, abort that transfer.</span></span></span>

<span class="text-4505230f--HeadingH700-04e1a2a3--textContentFamily-49a318e1"><span data-key="d395b8a9ab7941da87813f5848d43392"><span data-offset-key="d395b8a9ab7941da87813f5848d43392:0">When is a single transfer done?</span></span></span>

<span class="text-4505230f--TextH400-3033861f--textContentFamily-49a318e1"><span data-key="71bcfc34b20343999378bcbc2534eb8b"><span data-offset-key="71bcfc34b20343999378bcbc2534eb8b:0">As the examples above show, a program can detect when an individual transfer completes by seeing that the </span><span data-offset-key="71bcfc34b20343999378bcbc2534eb8b:1">`transfers_running`</span><span data-offset-key="71bcfc34b20343999378bcbc2534eb8b:2"> variable decreases.</span></span></span>

<span class="text-4505230f--TextH400-3033861f--textContentFamily-49a318e1"><span data-key="5fd353e27cc04092bf2ea791a9ca4021"><span data-offset-key="5fd353e27cc04092bf2ea791a9ca4021:0">It can also call </span><span data-offset-key="5fd353e27cc04092bf2ea791a9ca4021:1">`curl_multi_info_read()`</span><span data-offset-key="5fd353e27cc04092bf2ea791a9ca4021:2">, which will return a pointer to a struct (a "message") if a transfer has ended and you can then find out the result of that transfer using that struct.</span></span></span>

<span class="text-4505230f--TextH400-3033861f--textContentFamily-49a318e1"><span data-key="70d00ced014e4cb0a60cf1bbae919a38"><span data-offset-key="70d00ced014e4cb0a60cf1bbae919a38:0">When you do multiple parallel transfers, more than one transfer can of course complete in the same </span><span data-offset-key="70d00ced014e4cb0a60cf1bbae919a38:1">`curl_multi_perform`</span><span data-offset-key="70d00ced014e4cb0a60cf1bbae919a38:2"> invocation and then you might need more than one call to </span><span data-offset-key="70d00ced014e4cb0a60cf1bbae919a38:3">`curl_multi_info_read`</span><span data-offset-key="70d00ced014e4cb0a60cf1bbae919a38:4"> to get info about each completed transfer.</span></span></span>

<a href="easy.html" class="reset-3c756112--card-6570f064--whiteCard-fff091a4--cardPrevious-56a5e674"></a>

<span class="text-4505230f--TextH200-a3425406--textContentFamily-49a318e1">Previous</span>

<span class="text-4505230f--UIH400-4e41e82a--textContentFamily-49a318e1">Drive with easy</span>

<a href="multi-socket.html" class="reset-3c756112--card-6570f064--whiteCard-fff091a4--cardNext-19241c42"></a>

<span class="text-4505230f--TextH200-a3425406--textContentFamily-49a318e1">Next</span>

<span class="text-4505230f--UIH400-4e41e82a--textContentFamily-49a318e1">Drive with multi_socket</span>

<img src="https://avatars.githubusercontent.com/u/66654881?v=4" class="image-67b14f24--avatar-1c1d03ec" />

<span class="text-4505230f--TextH200-a3425406--textContentFamily-49a318e1">Last updated 11 months ago</span>

<span class="text-4505230f--UIH300-2063425d--textUIFamily-5ebd8e40"></span>
